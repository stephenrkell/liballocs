version: 2.0
jobs:
  build:
    docker:
      - image: ubuntu:24.04
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            dpkg --add-architecture i386
            apt update
            DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC apt install -y \
              $(cat .circleci/build-dependencies.txt)
      - run:
          name: Report compiler versions
          command: |
            gcc --version
            g++ --version
            dpkg -l | grep ocaml
      - run:
          name: Update submodules
          command: git submodule update --init --recursive
      - run:
          name: Build submodules
          command: make -C contrib -j 2
      - run:
          name: Build project
          command: |
            . contrib/env.sh
            ./autogen.sh
            ./configure
            make -j 2
      - persist_to_workspace:
          root: /
          paths: root/project usr/lib/meta
  test:
    requires:
      - build
    docker:
      - image: ubuntu:24.04
    steps:
      - attach_workspace:
          at: /
      - run:
          name: Install dependencies
          command: |
            apt update
            DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC apt install -y \
              $(cat /root/project/.circleci/test-dependencies.txt)
      - run:
          name: Run tests
          command: make -C /root/project/tests -k

workflows:
  version: 2
  default:
    jobs:
      - build
      - test:
          requires:
            - build
